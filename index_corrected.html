<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Bulk Gmail Sender (Test)</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    #editor { width: 100%; height: 150px; }
    #log { margin-top: 15px; white-space: pre-line; }
  </style>

  <!-- Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>

  <h2>Bulk Gmail Sender â€“ Test</h2>

  <!-- Login Button -->
  <div id="g_id_signin"></div>

  <p>
    <label>To:</label><br>
    <input type="email" id="to" style="width:300px" placeholder="recipient@example.com" />
  </p>

  <p>
    <label>Subject:</label><br>
    <input type="text" id="subject" style="width:300px" value="Test email from GIS + Gmail API" />
  </p>

  <p>
    <label>Message (HTML allowed):</label><br>
    <textarea id="editor"><p>Hello from Gmail API!</p></textarea>
  </p>

  <button id="sendBtn" disabled onclick="sendEmail()">Send Email</button>

  <div id="log"></div>

<script>
const CLIENT_ID = "863520838078-6buld4pv7anes58hloh473dms687gti1.apps.googleusercontent.com";

let accessToken = null;

window.onload = function() {
  google.accounts.id.initialize({
    client_id: CLIENT_ID,
    callback: handleCredentialResponse
  });

  google.accounts.id.renderButton(
    document.getElementById("g_id_signin"),
    { theme: "outline", size: "large", text: "signin_with" }
  );

  document.getElementById("log").innerText = "Please sign in with Google first.";
};

function handleCredentialResponse(response) {
  document.getElementById("log").innerText = "Signed in. Requesting Gmail permission...";

  const tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: CLIENT_ID,
    scope: "https://www.googleapis.com/auth/gmail.send",
    callback: (tokenResponse) => {
      accessToken = tokenResponse.access_token;
      document.getElementById("sendBtn").disabled = false;
      document.getElementById("log").innerText = "Gmail access granted. Ready to send emails.";
    }
  });

  tokenClient.requestAccessToken();
}

async function sendEmail() {
  if (!accessToken) {
    alert("Please sign in and grant Gmail permission first.");
    return;
  }

  const to = document.getElementById("to").value;
  const subject = document.getElementById("subject").value;
  const messageHtml = document.getElementById("editor").value;

  if (!to) {
    alert("Please enter a recipient email.");
    return;
  }

  document.getElementById("log").innerText = "Sending email...";

  const utf8Subject = "=?utf-8?B?" + btoa(unescape(encodeURIComponent(subject))) + "?=";

  const rawMessage = [
    "To: " + to,
    "Subject: " + utf8Subject,
    "Content-Type: text/html; charset='UTF-8'",
    "",
    messageHtml
  ].join("\r\n");

  const encodedMessage = btoa(rawMessage)
    .replace(/\+/g, "-")
    .replace(/\//g, "_")
    .replace(/=+$/, "");

  try {
    const response = await fetch(
      "https://gmail.googleapis.com/gmail/v1/users/me/messages/send",
      {
        method: "POST",
        headers: {
          "Authorization": "Bearer " + accessToken,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ raw: encodedMessage })
      }
    );

    const result = await response.text();
    document.getElementById("log").innerText = "EMAIL SENT SUCCESSFULLY:\n" + result;

  } catch (error) {
    document.getElementById("log").innerText = "ERROR:\n" + error.message;
  }
}
</script>

</body>
</html>
