<script>
/* ============================================================
   GLOBAL CONFIG + SHARED STATE + HELPERS
============================================================ */

const CLIENT_ID = "863520838078-6buld4pv7anes58hloh473dms687gti1.apps.googleusercontent.com";
const SCRIPT_WEBAPP_URL =
  "https://script.google.com/macros/s/AKfycbwIkB5esWB5CNoENAF1QmIv5pB5RIY_JSS2XDQg16f9HeDC2U5Q7Y7j7UXAcCBYU6CnaQ/exec";

const SECTIONS = ["home", "tools", "bulk-email", "report-formatter", "about"];

/* ---- Bulk Email State ---- */
let accessToken = null;
let sheetRows = [];
let failedRows = [];
let sending = false;

/* ---- Incident Report State ---- */
let IR_USER = null;
let IR_LOGIN_TIME = null;
let IR_AUTH_SIG = null;
let IR_PHOTOS = [];

/* ---- Daily Quota (Bulk Email) ---- */
const DAILY_LIMIT = 100;
const QUOTA_DAY_KEY = "owh_quota_day";
const QUOTA_COUNT_KEY = "owh_quota_count";

function getTodayKey() {
    const d = new Date();
    return `${d.getFullYear()}-${d.getMonth() + 1}-${d.getDate()}`;
}

function loadQuota() {
    const today = getTodayKey();
    const storedDay = localStorage.getItem(QUOTA_DAY_KEY);
    let count = Number(localStorage.getItem(QUOTA_COUNT_KEY) || 0);

    if (storedDay !== today) {
        count = 0;
        localStorage.setItem(QUOTA_DAY_KEY, today);
        localStorage.setItem(QUOTA_COUNT_KEY, "0");
    }
    return count;
}

function saveQuota(count) {
    localStorage.setItem(QUOTA_COUNT_KEY, String(count));
}

function quotaExceeded() {
    return loadQuota() >= DAILY_LIMIT;
}

function incrementQuota() {
    let count = loadQuota();
    count++;
    saveQuota(count);
    updateQuotaDisplay();
}

function updateQuotaDisplay() {
    const used = loadQuota();
    const countEl = document.getElementById("quotaCount");
    const limitEl = document.getElementById("quotaLimit");
    if (countEl) countEl.innerText = used;
    if (limitEl) limitEl.innerText = DAILY_LIMIT;
}

/* ---- Shared JWT Parser ---- */
function parseJwt(token) {
    const base64Url = token.split('.')[1];
    const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
    const jsonPayload = decodeURIComponent(
        atob(base64)
            .split('')
            .map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2))
            .join('')
    );
    return JSON.parse(jsonPayload);
}
</script>
<script>
/* ============================================================
   SECTION SWITCHING + DROPDOWN + BACKGROUND BUBBLES
============================================================ */

function showSection(id) {
    SECTIONS.forEach(secId => {
        const el = document.getElementById(secId);
        if (!el) return;
        if (secId === id) el.classList.remove("hidden-section");
        else el.classList.add("hidden-section");
    });

    window.scrollTo({ top: 0, behavior: "smooth" });

    const bubbleContainer = document.getElementById("bubble-container");
    if (bubbleContainer) {
        bubbleContainer.style.opacity = (id === "home") ? "1" : "0.35";
    }

    if (id === "bulk-email") {
        initGoogleButton();
        setupPerformaDrag();
        setupAttachmentDragDrop();
        updateSendButton();
        updateQuotaDisplay();
    }

    if (id === "report-formatter") {
        irActivateSection();
    }
}

/* ---- Dropdown (Tools) ---- */
function setupDropdown() {
    const toolsBtn = document.getElementById("toolsBtn");
    const dropdown = document.getElementById("toolsDropdown");
    if (!toolsBtn || !dropdown) return;

    function closeDropdown() {
        dropdown.classList.remove("show");
    }
    window.closeDropdown = closeDropdown;

    toolsBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        dropdown.classList.toggle("show");
    });

    document.addEventListener("click", (e) => {
        if (!dropdown.contains(e.target) && !toolsBtn.contains(e.target)) {
            closeDropdown();
        }
    });
}

/* ---- Floating Bubble Background ---- */
function spawnBubbles() {
    const container = document.getElementById("bubble-container");
    if (!container) return;

    const bubbleCount = 14;
    for (let i = 0; i < bubbleCount; i++) {
        const b = document.createElement("div");
        b.className = "bubble";

        const size = 80 + Math.random() * 180;
        const left = Math.random() * 100;
        const delay = Math.random() * 15;
        const duration = 16 + Math.random() * 12;
        const hue = 170 + Math.random() * 40;

        b.style.width = size + "px";
        b.style.height = size + "px";
        b.style.left = left + "vw";
        b.style.bottom = "-260px";
        b.style.background = `radial-gradient(circle at 30% 25%, rgba(255,255,255,0.7), hsla(${hue}, 80%, 30%, 0.1))`;
        b.style.animationDuration = duration + "s";
        b.style.animationDelay = delay + "s";

        container.appendChild(b);
    }
}
</script>
<script>
/* ============================================================
   BULK EMAIL — GOOGLE LOGIN + PERFORMA + ATTACHMENTS
============================================================ */

let bulkTokenClient = null;

/* ---- Google Sign-in button for Bulk Email ---- */
function initGoogleButton() {
    const container = document.getElementById("g_id_signin");
    if (!container) return;
    if (container.getAttribute("data-rendered") === "true") return;
    if (!window.google || !google.accounts || !google.accounts.id) return;

    google.accounts.id.initialize({
        client_id: CLIENT_ID,
        callback: handleBulkIdCredential
    });

    google.accounts.id.renderButton(container, {
        theme: "outline",
        size: "large"
    });

    container.setAttribute("data-rendered", "true");
}

/* ---- Handle ID Credential → Request OAuth Token ---- */
function handleBulkIdCredential() {
    const status = document.getElementById("loginStatus");
    if (status) status.innerText = "Requesting permissions…";

    if (!google.accounts || !google.accounts.oauth2) {
        if (status) status.innerText = "Google OAuth library not ready.";
        return;
    }

    if (!bulkTokenClient) {
        bulkTokenClient = google.accounts.oauth2.initTokenClient({
            client_id: CLIENT_ID,
            scope: "https://www.googleapis.com/auth/gmail.send https://www.googleapis.com/auth/drive.readonly",
            callback: (t) => {
                accessToken = t.access_token;
                if (status) status.innerText = "Login successful. Ready to send.";
                updateSendButton();
            }
        });
    }

    bulkTokenClient.requestAccessToken();
}

/* ---- Performa Template Download ---- */
function downloadPerforma() {
    const url =
      "https://docs.google.com/spreadsheets/d/1RLPZlir1TrV-pVE5qj8OKCBsAZWpcddUlwKvkGG56EY/export?format=xlsx";
    const a = document.createElement("a");
    a.href = url;
    a.download = "Performa.xlsx";
    a.click();
}

/* ---- Performa Drag & Drop + File Parse ---- */
function setupPerformaDrag() {
    const dz = document.getElementById("dropZone");
    const fileInput = document.getElementById("fileInput");
    if (!dz || !fileInput) return;

    const newDz = dz.cloneNode(true);
    dz.parentNode.replaceChild(newDz, dz);

    const newFileInput = fileInput.cloneNode(true);
    fileInput.parentNode.replaceChild(newFileInput, fileInput);

    newDz.addEventListener("dragover", (e) => {
        e.preventDefault();
        newDz.classList.add("border-bubble-teal", "bg-gray-900/40");
    });
    newDz.addEventListener("dragleave", () => {
        newDz.classList.remove("border-bubble-teal", "bg-gray-900/40");
    });
    newDz.addEventListener("drop", (e) => {
        e.preventDefault();
        newDz.classList.remove("border-bubble-teal", "bg-gray-900/40");
        if (e.dataTransfer.files && e.dataTransfer.files[0]) {
            handlePerformaFile(e.dataTransfer.files[0]);
        }
    });

    newFileInput.addEventListener("change", (e) => {
        if (e.target.files && e.target.files[0]) {
            handlePerformaFile(e.target.files[0]);
        }
    });
}

function handlePerformaFile(file) {
    const info = document.getElementById("fileInfo");
    if (!file || !file.name.endsWith(".xlsx")) {
        if (info) info.innerText = "Please select a valid .xlsx file.";
        return;
    }
    if (info) info.innerText = "Loaded: " + file.name;

    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const workbook = XLSX.read(new Uint8Array(e.target.result), { type: "array" });
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            const json = XLSX.utils.sheet_to_json(sheet, { header: 1 });

            if (json.length < 2) {
                if (info) info.innerText = "File has a header but no data rows.";
                sheetRows = [];
                renderTable([], []);
                updateSendButton();
                return;
            }

            const header = ["Name", "Email", "Attachment Name"];
            const idx = { name: 0, email: 1, attach: 2 };

            sheetRows = json.slice(1)
                .map(row => ({
                    name: row[idx.name] || "",
                    email: row[idx.email] || "",
                    attachmentName: row[idx.attach] || ""
                }))
                .filter(r => r.email);

            renderTable(header, sheetRows.map(r => [r.name, r.email, r.attachmentName]));
            updateSendButton();
        } catch (err) {
            console.error("Performa parse error:", err);
            if (info) info.innerText = "Error processing file. Please check console.";
            sheetRows = [];
            renderTable([], []);
            updateSendButton();
        }
    };

    reader.readAsArrayBuffer(file);
}

function renderTable(header, rows) {
    const container = document.getElementById("tableContainer");
    if (!container) return;

    if (!rows.length) {
        container.innerHTML = '<p class="text-gray-500 text-sm mt-2">No valid rows detected.</p>';
        return;
    }

    let html = `<p class="text-gray-400 text-sm mb-2">Previewing first 10 of ${rows.length} rows:</p>`;
    html += '<div class="overflow-x-auto">';
    html += '<table class="w-full text-sm border border-gray-700 rounded-lg overflow-hidden">';
    html += '<thead class="bg-gray-900"><tr>';
    header.forEach(h => {
        html += `<th class="px-3 py-2 text-left border-b border-gray-700 text-bubble-teal">${h}</th>`;
    });
    html += '</tr></thead><tbody>';

    rows.slice(0, 10).forEach(r => {
        html += '<tr class="border-b border-gray-800 hover:bg-gray-900/60">';
        html += `<td class="px-3 py-2">${r[0] || ""}</td>`;
        html += `<td class="px-3 py-2">${r[1] || ""}</td>`;
        html += `<td class="px-3 py-2">${r[2] || ""}</td>`;
        html += '</tr>';
    });

    html += '</tbody></table></div>';
    container.innerHTML = html;
}

/* ---- Attachments Drag & Drop ---- */
function setupAttachmentDragDrop() {
    const dz = document.getElementById("attachmentDropZone");
    const attachmentInput = document.getElementById("attachmentInput");
    if (!dz || !attachmentInput) return;

    const newDz = dz.cloneNode(true);
    dz.parentNode.replaceChild(newDz, dz);

    const newInput = attachmentInput.cloneNode(true);
    attachmentInput.parentNode.replaceChild(newInput, attachmentInput);

    newDz.addEventListener("dragover", (e) => {
        e.preventDefault();
        newDz.classList.add("border-bubble-teal", "bg-gray-900/40");
    });
    newDz.addEventListener("dragleave", () => {
        newDz.classList.remove("border-bubble-teal", "bg-gray-900/40");
    });
    newDz.addEventListener("drop", (e) => {
        e.preventDefault();
        newDz.classList.remove("border-bubble-teal", "bg-gray-900/40");
        if (e.dataTransfer.files && e.dataTransfer.files.length) {
            uploadAttachments(e.dataTransfer.files);
        }
    });

    newInput.addEventListener("change", (e) => {
        if (e.target.files && e.target.files.length) {
            uploadAttachments(e.target.files);
        }
    });
}

async function uploadAttachments(filesList) {
    const status = document.getElementById("attachmentUploadStatus");
    const files = Array.from(filesList || []);
    if (!files.length) {
        if (status) status.innerText = "No files selected.";
        return;
    }

    if (status) status.innerText = `Uploading ${files.length} file(s)…`;

    const formData = new FormData();
    formData.append("mode", "uploadAttachments");
    files.forEach(f => formData.append("files", f, f.name));

    try {
        const res = await fetch(SCRIPT_WEBAPP_URL, {
            method: "POST",
            body: formData
        });
        const data = await res.json();
        if (Array.isArray(data)) {
            if (status) status.innerText = `Uploaded ${data.length} file(s) successfully.`;
        } else if (data && typeof data === "object" && data.success === false) {
            if (status) status.innerText = `Upload failed: ${data.error || "Server error."}`;
        } else {
            if (status) status.innerText = "Upload completed.";
        }
    } catch (err) {
        console.error("Attachment upload error:", err);
        if (status) status.innerText = "Upload failed. See console.";
    }
}

/* ---- Send Button Enable Logic ---- */
function updateSendButton() {
    const sendBtn = document.getElementById("sendBtn");
    if (!sendBtn) return;

    const subject = document.getElementById("subject")?.value.trim();
    const msg = document.getElementById("editor")?.value.trim();

    const ok = accessToken &&
               sheetRows.length > 0 &&
               subject &&
               msg &&
               !sending &&
               !quotaExceeded();

    sendBtn.disabled = !ok;

    if (quotaExceeded()) {
        sendBtn.textContent = "Daily Limit Reached";
        sendBtn.classList.add("opacity-60", "cursor-not-allowed");
    } else {
        sendBtn.textContent = "Start Sending Emails";
        if (ok) {
            sendBtn.classList.remove("opacity-60", "cursor-not-allowed");
        } else {
            sendBtn.classList.add("opacity-60", "cursor-not-allowed");
        }
    }
}
</script>
<script>
/* ============================================================
   BULK EMAIL — SENDING LOGIC + FAILED CSV
============================================================ */

async function startBulkSend() {
    if (!sheetRows.length) return;
    sending = true;
    updateSendButton();

    const failedBtn = document.getElementById("failedBtn");
    if (failedBtn) failedBtn.classList.add("hidden");

    const subject = document.getElementById("subject").value.trim();
    const msg = document.getElementById("editor").value.trim();

    const total = sheetRows.length;
    failedRows = [];
    const startTime = Date.now();

    for (let i = 0; i < total; i++) {
        const row = sheetRows[i];
        const htmlBody = msg.replace(/{{Name}}/g, row.name || "Sir/Madam");

        const progressEl = document.getElementById("progress");
        const logEl = document.getElementById("log");
        const etaEl = document.getElementById("eta");

        if (progressEl) progressEl.innerText = `Sending ${i + 1}/${total}…`;
        if (logEl) logEl.innerText = `Current: ${row.email}`;

        const ok = await sendOne(row, subject, htmlBody);
        if (!ok) {
            failedRows.push(row);
        } else {
            incrementQuota();
        }

        const elapsed = (Date.now() - startTime) / 1000;
        const avg = elapsed / (i + 1);
        const remaining = Math.round(avg * (total - (i + 1)));
        if (etaEl) etaEl.innerText = `Estimated time left: ${remaining}s`;

        await new Promise(res => setTimeout(res, 300));
    }

    sending = false;
    updateSendButton();

    const progressEl = document.getElementById("progress");
    const logEl = document.getElementById("log");
    const etaEl = document.getElementById("eta");

    if (!failedRows.length) {
        if (progressEl) progressEl.innerText = "All emails sent successfully ✅";
        const sound = document.getElementById("successSound");
        if (sound) sound.play().catch(() => {});
    } else {
        if (progressEl) {
            progressEl.innerText =
              `${total - failedRows.length}/${total} sent successfully, ${failedRows.length} failed.`;
        }
        if (failedBtn) failedBtn.classList.remove("hidden");
    }

    if (logEl) logEl.innerText = "Done.";
    if (etaEl) etaEl.innerText = "";
}

async function sendOne(row, subject, htmlBody) {
    try {
        const res = await fetch(SCRIPT_WEBAPP_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                mode: "sendEmailWithAttachmentName",
                to: row.email,
                subject,
                htmlBody,
                attachmentName: row.attachmentName,
                accessToken
            })
        });
        const data = await res.json();
        return !!data.success;
    } catch (err) {
        console.error("Send error for", row.email, err);
        return false;
    }
}

function downloadFailed() {
    if (!failedRows.length) return;

    let csv = "Name,Email,Attachment Name\n";
    failedRows.forEach(r => {
        csv += `"${r.name}","${r.email}","${r.attachmentName}"\n`;
    });

    const blob = new Blob([csv], { type: "text/csv" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "failed_rows.csv";
    a.click();
    URL.revokeObjectURL(url);
}
</script>
<script>
/* ============================================================
   INCIDENT REPORT — AUTH SYSTEM (LOGIN INSIDE TOOL)
============================================================ */

function irInitGoogleButton() {
    const container = document.getElementById("ir-google-signin");
    if (!container) return;
    if (container.getAttribute("data-rendered") === "true") return;
    if (!window.google || !google.accounts || !google.accounts.id) return;

    google.accounts.id.initialize({
        client_id: CLIENT_ID,
        callback: irHandleLogin
    });

    google.accounts.id.renderButton(container, {
        theme: "outline",
        size: "large",
        width: 260
    });

    container.setAttribute("data-rendered", "true");
}

function irHandleLogin(response) {
    const jwt = parseJwt(response.credential);

    IR_USER = {
        name: jwt.name,
        email: jwt.email,
        picture: jwt.picture,
        id: jwt.sub
    };

    IR_LOGIN_TIME = new Date();

    document.getElementById("ir-login-gate").classList.add("hidden");
    document.getElementById("ir-user-info").classList.remove("hidden");

    document.getElementById("ir-user-name").textContent = IR_USER.name;
    document.getElementById("ir-user-email").textContent = IR_USER.email;
    document.getElementById("ir-user-photo").src = IR_USER.picture;

    document.getElementById("ir-tool-container").classList.remove("hidden");

    irUpdatePreview();
}

function irLogout() {
    IR_USER = null;
    IR_LOGIN_TIME = null;
    IR_AUTH_SIG = null;

    document.getElementById("ir-user-info").classList.add("hidden");
    document.getElementById("ir-login-gate").classList.remove("hidden");
    document.getElementById("ir-tool-container").classList.add("hidden");
    document.getElementById("ir-preview").innerHTML = "";
}

function irActivateSection() {
    irInitGoogleButton();

    if (!IR_USER) {
        document.getElementById("ir-login-gate").classList.remove("hidden");
        document.getElementById("ir-user-info").classList.add("hidden");
        document.getElementById("ir-tool-container").classList.add("hidden");
    } else {
        document.getElementById("ir-login-gate").classList.add("hidden");
        document.getElementById("ir-user-info").classList.remove("hidden");
        document.getElementById("ir-tool-container").classList.remove("hidden");
    }

    irUpdatePreview();
}
</script>
<script>
/* ============================================================
   INCIDENT REPORT — FORMALIZER + PHOTO HANDLING + PREVIEW
============================================================ */

function irFormalizeText(raw) {
    if (!raw || raw.trim().length === 0) return "";
    let text = raw.trim();
    text = text.charAt(0).toUpperCase() + text.slice(1);

    text = text.replace(/\bgot\b/gi, "received")
               .replace(/\bgive\b/gi, "provided")
               .replace(/\bwe saw\b/gi, "it was observed that")
               .replace(/\bsaw\b/gi, "observed")
               .replace(/\bmet\b/gi, "encountered")
               .replace(/\bhit\b/gi, "struck")
               .replace(/\bbeat\b/gi, "assaulted")
               .replace(/\bpush(ed)?\b/gi, "pushed");

    if (!/[.!?]$/.test(text)) text += ".";
    return text;
}

/* Photo list is stored in IR_PHOTOS; change handler is added on DOMContentLoaded */

function irUpdatePreview() {
    const p = document.getElementById("ir-preview");
    if (!p) return;

    if (!IR_USER) {
        p.innerHTML = "<p class='text-gray-500 text-sm'>Please sign in to start filling the report.</p>";
        return;
    }

    const summary        = document.getElementById("ir-summary").value.trim();
    const datetime       = document.getElementById("ir-datetime").value.trim();
    const location       = document.getElementById("ir-location").value.trim();
    const persons        = document.getElementById("ir-persons").value.trim();
    const rawDescription = document.getElementById("ir-description-raw").value.trim();
    const actions        = document.getElementById("ir-actions").value.trim();
    const damage         = document.getElementById("ir-damage").value.trim();
    const witness        = document.getElementById("ir-witness").value.trim();
    const officer        = document.getElementById("ir-officer").value.trim();

    const description = irFormalizeText(rawDescription);

    const authBlock = `
        <div class="mt-6 p-4 border border-gray-800 bg-black/20 rounded">
            <h4 class="font-semibold text-xs tracking-wider text-gray-400 uppercase mb-2">Authenticated User</h4>
            <p class="text-gray-300 text-sm">
                <strong>Name:</strong> ${IR_USER.name}<br>
                <strong>Email:</strong> ${IR_USER.email}<br>
                <strong>Google ID:</strong> ${IR_USER.id}<br>
                <strong>Login Time:</strong> ${IR_LOGIN_TIME.toLocaleString()}
            </p>
        </div>
    `;

    let photosHTML = "";
    IR_PHOTOS.forEach((pObj, idx) => {
        const caption = pObj.captionInput.value || `Photo ${idx + 1}`;
        photosHTML += `
            <div class="mt-4">
                <img src="${pObj.url}" class="rounded border border-gray-800 max-h-64 w-full object-cover mb-1">
                <p class="text-xs text-gray-400 italic">${caption}</p>
            </div>
        `;
    });

    const uidFrag = IR_USER.id.slice(-4);
    const ts = Date.now().toString();
    const random = Math.floor(Math.random() * 999999).toString();
    const rawSig = uidFrag + "|" + ts + "|" + random;

    IR_AUTH_SIG = btoa(rawSig).slice(0, 24);

    const watermarkHTML = `
        <div class="text-[9px] text-gray-500 opacity-70 text-right mt-4">
            Verified Report • officeworkhelp.in<br>
            AuthSig: ${IR_AUTH_SIG}
        </div>
    `;

    p.innerHTML = `
        <h2 class="text-xl font-bold text-white mb-4">Incident Report</h2>

        <p><strong>Incident Summary:</strong> ${summary || "-"}</p>
        <p><strong>Date & Time:</strong> ${datetime || "-"}</p>
        <p><strong>Location:</strong> ${location || "-"}</p>
        <p><strong>Persons Involved:</strong> ${persons || "-"}</p>

        <p class="mt-4"><strong>Description of Events:</strong><br>${description || "-"}</p>

        <p class="mt-4"><strong>Actions Taken:</strong><br>${actions || "-"}</p>

        <p class="mt-4"><strong>Injuries / Damage:</strong><br>${damage || "-"}</p>

        <p class="mt-4"><strong>Witness Statements:</strong><br>${witness || "-"}</p>

        ${photosHTML}

        ${authBlock}
        ${watermarkHTML}

        <p class="mt-6"><strong>Reporting Officer:</strong> ${officer || "-"}</p>
    `;
}
</script>
<script>
/* ============================================================
   INCIDENT REPORT — EXPORT ENGINE (PDF + WORD + HASH)
============================================================ */

async function irSHA256(str) {
    const enc = new TextEncoder().encode(str);
    const buf = await crypto.subtle.digest("SHA-256", enc);
    return Array.from(new Uint8Array(buf))
        .map(b => b.toString(16).padStart(2, "0"))
        .join("");
}

async function irBuildExportHTML() {
    if (!IR_USER) return "";

    const preview = document.getElementById("ir-preview").innerHTML;

    const salt = Math.random().toString(36).substring(2, 12);
    const ts = Date.now().toString();
    const data = IR_USER.email + "|" + IR_USER.id + "|" + ts + "|" + salt;

    const hash = await irSHA256(data);
    IR_AUTH_SIG = hash.substring(0, 32);
    const uidc = IR_USER.id.slice(-4);

    const hiddenComment = `
        <!-- AUTH_SIG:${IR_AUTH_SIG};UIDC:${uidc};TS:${ts};SALT:${salt} -->
    `;

    return `
        <div style="font-family: Inter, sans-serif; color: #222; line-height: 1.5;">
            ${preview}
            <div style="font-size: 9px; text-align: right; opacity: .6; margin-top: 20px;">
                Verified Report • officeworkhelp.in<br>
                AuthSig: ${IR_AUTH_SIG}
            </div>
        </div>
        ${hiddenComment}
    `;
}

async function irExportPDF() {
    if (!IR_USER) {
        alert("Please sign in to generate a report.");
        return;
    }

    const html = await irBuildExportHTML();

    const container = document.createElement("div");
    container.innerHTML = html;
    document.body.appendChild(container);

    const opt = {
        margin: 0.6,
        filename: `Incident_Report_${Date.now()}.pdf`,
        html2canvas: { scale: 2 },
        jsPDF: { unit: "in", format: "a4", orientation: "portrait" }
    };

    await html2pdf().set(opt).from(container).save();
    container.remove();
}

async function irExportWord() {
    if (!IR_USER) {
        alert("Please sign in to generate a report.");
        return;
    }

    const html = await irBuildExportHTML();

    const header =
        `<!DOCTYPE html>
        <html>
        <head>
            <meta charset="utf-8">
            <title>Incident Report</title>
        </head>
        <body>`;

    const footer = `</body></html>`;

    const fullHTML = header + html + footer;

    const blob = new Blob([fullHTML], {
        type: "application/vnd.openxmlformats-officedocument.wordprocessingml.document"
    });

    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `Incident_Report_${Date.now()}.docx`;
    a.click();
    URL.revokeObjectURL(a.href);
}
</script>
<script>
/* ============================================================
   FINAL INITIALIZATION — RUNS ON PAGE LOAD
============================================================ */

document.addEventListener("DOMContentLoaded", () => {
    // Default section
    showSection("home");

    // Background
    spawnBubbles();
    setupDropdown();

    // Google buttons (each tool)
    initGoogleButton();
    irInitGoogleButton();

    // Bulk Email setup
    setupPerformaDrag();
    setupAttachmentDragDrop();
    updateQuotaDisplay();

    // Update send button when subject/body change
    document.addEventListener("input", (e) => {
        if (e.target.id === "subject" || e.target.id === "editor") {
            updateSendButton();
        }
    });

    // Incident Report inputs live-preview
    document.addEventListener("input", (e) => {
        const IR_FIELDS = [
            "ir-summary", "ir-datetime", "ir-location", "ir-persons",
            "ir-description-raw", "ir-actions", "ir-damage",
            "ir-witness", "ir-officer"
        ];
        if (IR_FIELDS.includes(e.target.id)) irUpdatePreview();
    });

    // Incident Report photos change
    const photoInput = document.getElementById("ir-photos");
    if (photoInput) {
        photoInput.addEventListener("change", function () {
            IR_PHOTOS = [];
            const preview = document.getElementById("ir-photo-list");
            if (!preview) return;
            preview.innerHTML = "";

            Array.from(this.files).forEach(file => {
                const url = URL.createObjectURL(file);
                const container = document.createElement("div");
                container.className = "bg-gray-900 p-3 rounded-lg border border-gray-700";

                container.innerHTML = `
                    <img src="${url}" class="w-full max-h-40 object-cover rounded mb-2 border border-gray-800">
                    <input type="text" class="w-full px-2 py-1 bg-gray-800 border border-gray-700 rounded text-sm text-gray-300"
                           placeholder="Caption for this photo">
                `;
                preview.appendChild(container);

                IR_PHOTOS.push({
                    url,
                    captionInput: container.querySelector("input")
                });
            });

            irUpdatePreview();
        });
    }
});
</script>
