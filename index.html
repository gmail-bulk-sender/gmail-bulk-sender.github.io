<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>officeworkhelp.in ‚Äì Tools & Bulk Email Sender</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Tailwind Config -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif'],
          },
          colors: {
            'gray-950': '#020617'
          }
        }
      }
    }
  </script>

  <!-- Inter Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet" />

  <!-- Google Login SDK -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <!-- XLSX Parser -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    body { font-family: 'Inter', sans-serif; }

    .hidden-section { display: none; }

    .glow-button {
      --glow-color: #2dd4bf;
      border: 1px solid var(--glow-color);
      transition: all 0.25s ease;
    }
    .glow-button:hover {
      box-shadow: 0 0 12px var(--glow-color);
      transform: translateY(-1px);
      background-color: rgba(45, 212, 191, 0.15);
    }

    /* Bubbles Hero */
    .hero-wrapper {
      position: relative;
      overflow: hidden;
      border-radius: 1.25rem;
      background: radial-gradient(circle at top, #0f172a 0%, #020617 55%, #000 100%);
      box-shadow: 0 24px 60px rgba(15, 23, 42, 0.95);
      min-height: 420px;
    }
    .hero-overlay {
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at 15% 15%, rgba(56,189,248,0.18), transparent 55%),
                  radial-gradient(circle at 80% 80%, rgba(45,212,191,0.22), transparent 55%);
      mix-blend-mode: screen;
    }
    .hero-bubble {
      position: absolute;
      border-radius: 999px;
      background: radial-gradient(circle at 25% 20%, rgba(255,255,255,0.5), rgba(15,23,42,1));
      opacity: 0.5;
      mix-blend-mode: screen;
      animation: float 18s ease-in-out infinite;
    }
    @keyframes float {
      0% { transform: translate(0,0); opacity: .5; }
      50% { transform: translate(30px,-40px); opacity: .95; }
      100% { transform: translate(0,0); opacity: .5; }
    }

    /* Drag zones */
    #dropZone, #attachmentDropZone {
      border: 2px dashed #4b5563;
      padding: 16px;
      border-radius: 10px;
      background:#020617;
      text-align:center;
      color:#9ca3af;
    }
    .dragover {
      background: rgba(45,212,191,0.12) !important;
      border-color:#22d3ee !important;
    }

    .preview-table {
      width:100%; border-collapse:collapse; font-size:.85rem;
    }
    .preview-table th { background:#020617; color:#22d3ee; }
    .preview-table th, .preview-table td {
      border:1px solid #1f2937; padding:6px 8px;
    }
  </style>
</head>

<body class="bg-gray-950 text-gray-100 antialiased">

<!-- NAVBAR -->
<header class="sticky top-0 z-40 bg-gray-950/90 backdrop-blur border-b border-gray-800">
  <div class="max-w-6xl mx-auto px-4 sm:px-6 py-3 flex items-center justify-between">

    <div class="flex items-center gap-2 cursor-pointer" onclick="showSection('home')">
      <span class="inline-flex h-8 w-8 items-center justify-center rounded-xl bg-cyan-500/10 border border-cyan-400/40">
        <span class="h-2.5 w-2.5 rounded-full bg-cyan-400 shadow-[0_0_12px_rgba(34,211,238,0.9)]"></span>
      </span>
      <span class="font-black tracking-tight text-xl text-cyan-300">officeworkhelp.in</span>
    </div>

    <nav class="flex items-center gap-4 text-sm">
      <button class="text-gray-300 hover:text-cyan-300" onclick="showSection('home')">Home</button>
      <button class="text-gray-300 hover:text-cyan-300" onclick="showSection('tools')">Tools</button>
      <button class="text-gray-300 hover:text-cyan-300" onclick="showSection('about')">About</button>

      <button class="ml-3 glow-button px-3 py-1.5 rounded-lg text-xs font-semibold bg-cyan-500/10 text-cyan-300"
              onclick="showSection('bulk-sender')">
        Launch App
      </button>
    </nav>

  </div>
</header>

<main class="max-w-6xl mx-auto px-4 sm:px-6 py-8 space-y-16">

<!-- ================= HOME SECTION ================= -->
<section id="home" class="space-y-10">

  <div id="hero" class="hero-wrapper px-6 py-12 sm:px-10 sm:py-16">

    <!-- Floating Bubbles -->
    <div class="hero-bubble" style="width:220px;height:220px;left:8%;top:55%;animation-duration:24s;"></div>
    <div class="hero-bubble" style="width:160px;height:160px;left:70%;top:25%;animation-duration:20s;"></div>
    <div class="hero-bubble" style="width:260px;height:260px;left:42%;top:65%;animation-duration:28s;"></div>

    <div class="hero-overlay"></div>

    <div class="relative text-center">
      <p class="text-cyan-300 text-xs font-mono tracking-[0.35em] uppercase mb-4">
        ENGINEERING PRODUCTIVITY ¬∑ FOR FREE
      </p>

      <h1 class="text-4xl sm:text-6xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-cyan-100 to-cyan-300">
        Helping hard work meet smart work
      </h1>

      <p class="mt-4 text-sm sm:text-base text-gray-300 max-w-2xl mx-auto">
        Turn repetitive office routines into streamlined, automated flows.  
        Build once ‚Äî reuse forever.
      </p>

      <div class="mt-8 flex flex-col sm:flex-row gap-3 justify-center">
        <button class="glow-button px-6 py-2.5 rounded-xl bg-cyan-500/10 text-cyan-200 hover:text-white"
                onclick="showSection('tools')">
          Browse Free Tools
        </button>
        <button class="px-6 py-2.5 rounded-xl border border-gray-700 text-gray-300 hover:border-cyan-400 hover:text-cyan-200"
                onclick="showSection('bulk-sender')">
          Go to Bulk Email Sender ‚Üí
        </button>
      </div>
    </div>
  </div>
<!-- ================= TOOLS DIRECTORY ================= -->
<section id="tools" class="hidden-section space-y-8">
  <div>
    <p class="text-xs font-mono tracking-[0.3em] uppercase text-cyan-400 mb-2">Tool Suite</p>
    <h2 class="text-2xl sm:text-3xl font-extrabold text-white">Pick a workflow helper</h2>
    <p class="text-sm text-gray-400 mt-2">
      Start with the tool that removes the most repetitive work from your week.
    </p>
  </div>

  <div class="grid gap-6 md:grid-cols-3">
    <!-- Bulk Email Sender tool card -->
    <div class="tool-card cursor-pointer hover:border-cyan-400/70 transition"
         onclick="showSection('bulk-sender')">
      <h3 class="text-lg font-semibold text-cyan-300 mb-1">
        Bulk Email Sender with Attachments
      </h3>
      <p class="text-xs sm:text-sm text-gray-300 mb-3">
        Send customized emails where each recipient gets their own specific attachment, defined via an .xlsx sheet.
      </p>
      <div class="flex items-center justify-between text-xs text-gray-400">
        <span>Status: <span class="text-emerald-400">Live</span></span>
        <span class="text-cyan-300 font-semibold">Open Tool ‚Üí</span>
      </div>
    </div>

    <!-- Placeholder tool 1 -->
    <div class="tool-card opacity-60 border-dashed">
      <h3 class="text-lg font-semibold text-gray-400 mb-1">Report Formatter (Coming Soon)</h3>
      <p class="text-xs sm:text-sm text-gray-500 mb-3">
        Automatically convert raw data into clean PDF / DOC reports.
      </p>
      <span class="text-xs text-yellow-400">In design phase</span>
    </div>

    <!-- Placeholder tool 2 -->
    <div class="tool-card opacity-60 border-dashed">
      <h3 class="text-lg font-semibold text-gray-400 mb-1">Data Sync Assistant (Coming Soon)</h3>
      <p class="text-xs sm:text-sm text-gray-500 mb-3">
        Sync Google Sheets with local datasets ‚Äî no manual exports needed.
      </p>
      <span class="text-xs text-yellow-400">Planned</span>
    </div>
  </div>
</section>

<!-- ================= BULK EMAIL SENDER TOOL ================= -->
<section id="bulk-sender" class="hidden-section space-y-8">
  <div class="flex items-center justify-between gap-3 border-b border-gray-800 pb-4">
    <div>
      <p class="text-xs text-gray-500 mb-1">
        <button class="text-gray-400 hover:text-cyan-300" onclick="showSection('tools')">Tools</button>
        <span class="mx-1 text-gray-600">/</span>
        <span class="text-gray-300">Bulk Email Sender with Attachments</span>
      </p>
      <h2 class="text-2xl sm:text-3xl font-extrabold text-cyan-300">
        Bulk Email Sender with Attachments
      </h2>
      <p class="text-xs sm:text-sm text-gray-400 mt-1 max-w-xl">
        Upload a Performa (.xlsx) containing Name, Email, and Attachment Name.  
        Upload matching attachments, and send in one automated batch.
      </p>
    </div>

    <button class="hidden sm:inline-flex text-xs text-gray-400 hover:text-cyan-300"
            onclick="showSection('home')">
      ‚Üê Back to Home
    </button>
  </div>

  <div class="grid lg:grid-cols-2 gap-6 items-start">

    <!-- LEFT COLUMN -->
    <div class="space-y-6">
      <!-- Login Box -->
      <div class="tool-card">
        <h3 class="text-lg font-semibold text-cyan-300 mb-2">1. Sign in with Google</h3>
        <p class="text-xs sm:text-sm text-gray-400 mb-3">
          Allow this tool to send emails and retrieve Drive attachments via Google OAuth.
        </p>
        <div id="g_id_signin" class="mb-2"></div>
        <div id="loginStatus" class="text-xs text-gray-400"></div>
      </div>

      <!-- Performa + Attachments -->
      <div class="tool-card space-y-4">

        <div>
          <h3 class="text-lg font-semibold text-cyan-300 mb-1">2. Upload Performa & Attachments</h3>
          <p class="text-xs text-gray-400">
            Required columns in Performa: <code>Name</code>, <code>Email</code>, <code>Attachment Name</code>.
          </p>
        </div>

        <!-- Download template -->
        <button onclick="downloadPerforma()"
                class="glow-button px-4 py-2 rounded-lg bg-cyan-500/10 text-cyan-200 text-xs hover:text-white">
          Download Performa Template (.xlsx)
        </button>

        <!-- Performa upload -->
        <div class="space-y-2">
          <label class="text-xs font-semibold text-gray-300">Performa (.xlsx)</label>
          <input type="file" id="fileInput" accept=".xlsx" />
          <div id="dropZone">Drag & drop Performa here</div>
          <div id="fileInfo" class="text-xs text-gray-400 mt-1"></div>
          <div id="tableContainer" class="mt-3 text-xs"></div>
        </div>

        <hr class="border-gray-800 my-2" />

        <!-- Attachments upload -->
        <div class="space-y-2">
          <label class="text-xs font-semibold text-gray-300">Attachments</label>
          <input type="file" id="attachmentInput" multiple />
          <div id="attachmentDropZone">Drag & drop all attachments here</div>
          <div id="attachmentUploadStatus" class="text-xs text-gray-400 mt-1"></div>
        </div>
      </div>
    </div>

    <!-- RIGHT COLUMN -->
    <div class="space-y-6">

      <!-- Email Content -->
      <div class="tool-card space-y-3">
        <h3 class="text-lg font-semibold text-cyan-300 mb-1">3. Email Content</h3>

        <div>
          <label class="text-xs font-semibold text-gray-300">Subject</label>
          <input type="text" id="subject" value="Your Document" />
        </div>

        <div>
          <label class="text-xs font-semibold text-gray-300 block mb-1">
            HTML Message
            <span class="text-gray-500"> ¬∑ use <code>{{Name}}</code></span>
          </label>
          <textarea id="editor" rows="8" class="font-mono text-xs">
<p>Dear {{Name}},</p>
<p>Your document is attached below.</p>
<p>Regards,<br/>Office</p>
          </textarea>
        </div>
      </div>

      <!-- Send Box -->
      <div class="tool-card space-y-3">
        <h3 class="text-lg font-semibold text-cyan-300 mb-2">4. Send Emails</h3>

        <button id="sendBtn"
                disabled
                onclick="startBulkSend()"
                class="glow-button px-5 py-2.5 rounded-xl bg-cyan-500/10 text-cyan-200 text-sm font-semibold opacity-60 cursor-not-allowed">
          Start Sending Emails
        </button>

        <div id="progress" class="text-sm font-semibold text-cyan-300 mt-1"></div>
        <div id="eta" class="text-xs text-gray-400"></div>
        <div id="log" class="text-xs text-gray-500 font-mono mt-1"></div>

        <button id="failedBtn"
                onclick="downloadFailed()"
                class="hidden mt-3 px-4 py-1.5 rounded-lg text-xs font-semibold bg-red-600 text-white hover:bg-red-500">
          Download Failed Rows (CSV)
        </button>
      </div>

    </div>
  </div>
</section>
<!-- ================= ABOUT ================= -->
<section id="about" class="hidden-section space-y-10">

  <div>
    <p class="text-xs font-mono tracking-[0.3em] uppercase text-cyan-400 mb-2">About</p>
    <h2 class="text-2xl sm:text-3xl font-extrabold text-white">Who is behind officeworkhelp.in?</h2>
  </div>

  <div class="grid md:grid-cols-3 gap-8 items-center">
    
    <!-- Clean circular profile image -->
    <div class="flex justify-center">
      <img
        src="https://drive.google.com/thumbnail?id=1LNKUmmTxJUx9NAE2UgNQDNAHesgFJrHD"
        alt="Chetan Sharma"
        class="h-44 w-44 sm:h-56 sm:w-56 rounded-full object-cover shadow-xl shadow-cyan-500/20 border border-cyan-400/30"
      />
    </div>

    <div class="md:col-span-2 space-y-4 text-sm sm:text-base text-gray-300">
      <p>
        Hi, I‚Äôm <span class="font-semibold text-white">Chetan Sharma</span>, the creator of 
        <span class="text-cyan-300 font-semibold">officeworkhelp.in</span>.
      </p>
      
      <p>
        I‚Äôve seen countless professionals waste time on repetitive tasks ‚Äî
        sending bulk emails, formatting sheets, preparing reports ‚Äî
        work that should be automated, not manually repeated.
      </p>

      <p>
        My mission is simple:
        <span class="font-semibold text-cyan-300">
          make fast, practical workflow automation free and accessible to everyone.
        </span>
        Tools that save hours, reduce mistakes, and help you focus on what actually matters.
      </p>

      <a href="https://www.linkedin.com/in/chetan-sharma-4570a1100/" target="_blank"
         class="glow-button inline-flex items-center gap-2 px-5 py-2 rounded-lg bg-cyan-500/10 text-cyan-200 text-xs sm:text-sm hover:text-white">
        Connect on LinkedIn ‚Üí
      </a>
    </div>

  </div>
</section>


<!-- FOOTER -->
<footer class="border-t border-gray-800 bg-gray-950/95 mt-10">
  <div class="max-w-6xl mx-auto px-4 sm:px-6 py-4 text-center text-[11px] sm:text-xs text-gray-500">
    ¬© 2025 officeworkhelp.in ¬∑ Helping hard work meet smart work.
  </div>
</footer>


<!-- Success sound -->
<audio id="successSound">
  <source src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg" type="audio/ogg" />
</audio>


<!-- ================= MAIN SCRIPT (Bulk Sender + OAuth + UI Logic) ================= -->
<script>
/* ========= CONFIG ========= */
const CLIENT_ID = "863520838078-6buld4pv7anes58hloh473dms687gti1.apps.googleusercontent.com";
const SCRIPT_WEBAPP_URL =
  "https://script.google.com/macros/s/AKfycbwIkB5esWB5CNoENAF1QmIv5pB5RIY_JSS2XDQg16f9HeDC2U5Q7Y7j7UXAcCBYU6CnaQ/exec";

let accessToken = null;
let sheetRows = [];
let failedRows = [];
let sending = false;

const SECTIONS = ["home", "tools", "bulk-sender", "about"];

/* ================= SHOW / HIDE SECTIONS ================= */
function showSection(id) {
  SECTIONS.forEach(sec => {
    const el = document.getElementById(sec);
    if (!el) return;
    el.classList.toggle("hidden-section", sec !== id);
  });
  window.scrollTo({ top: 0, behavior: "smooth" });
}

/* ================= INIT ================= */
document.addEventListener("DOMContentLoaded", () => {
  showSection("home");

  /* Google Identity */
  if (google?.accounts?.id) {
    google.accounts.id.initialize({
      client_id: CLIENT_ID,
      callback: handleLogin
    });

    if (document.getElementById("g_id_signin")) {
      google.accounts.id.renderButton(
        document.getElementById("g_id_signin"),
        { theme: "outline", size: "large" }
      );
    }
  }

  setupPerformaDrag();
  setupAttachmentDragDrop();

  /* Hero tilt effect */
  const hero = document.getElementById("hero");
  if (hero) {
    hero.addEventListener("mousemove", e => {
      const r = hero.getBoundingClientRect();
      const x = (e.clientX - r.left) / r.width - 0.5;
      const y = (e.clientY - r.top) / r.height - 0.5;
      hero.style.transform =
        `perspective(1100px) rotateX(${y * -8}deg) rotateY(${x * 10}deg) scale(1.01)`;
    });
    hero.addEventListener("mouseleave", () => {
      hero.style.transform = "perspective(1100px) rotateX(0) rotateY(0) scale(1)";
    });
  }
});

/* ================= LOGIN ================= */
function handleLogin() {
  const status = document.getElementById("loginStatus");
  if (status) status.innerText = "Requesting permissions‚Ä¶";

  const tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: CLIENT_ID,
    scope:
      "https://www.googleapis.com/auth/gmail.send https://www.googleapis.com/auth/drive.readonly",
    callback: t => {
      accessToken = t.access_token;
      if (status) status.innerText = "Login successful.";
      updateSendButton();
    }
  });
  tokenClient.requestAccessToken();
}

/* ================= DOWNLOAD PERFORMA ================= */
function downloadPerforma() {
  const url =
    "https://docs.google.com/spreadsheets/d/1RLPZlir1TrV-pVE5qj8OKCBsAZWpcddUlwKvkGG56EY/export?format=xlsx";
  const a = document.createElement("a");
  a.href = url;
  a.download = "Performa.xlsx";
  a.click();
}

/* ================= PERFORMA UPLOAD ================= */
function setupPerformaDrag() {
  const dz = document.getElementById("dropZone");
  const input = document.getElementById("fileInput");
  if (!dz || !input) return;

  dz.addEventListener("dragover", e => {
    e.preventDefault();
    dz.classList.add("dragover");
  });

  dz.addEventListener("dragleave", () => dz.classList.remove("dragover"));

  dz.addEventListener("drop", e => {
    e.preventDefault();
    dz.classList.remove("dragover");
    if (e.dataTransfer.files[0]) handlePerformaFile(e.dataTransfer.files[0]);
  });

  input.addEventListener("change", e => {
    if (e.target.files[0]) handlePerformaFile(e.target.files[0]);
  });
}

function handlePerformaFile(file) {
  const info = document.getElementById("fileInfo");
  if (!file || !file.name.endsWith(".xlsx")) {
    info.innerText = "Please upload a valid .xlsx file.";
    return;
  }
  info.innerText = "Loaded: " + file.name;

  const reader = new FileReader();
  reader.onload = e => {
    try {
      const wb = XLSX.read(new Uint8Array(e.target.result), { type: "array" });
      const sheet = wb.Sheets[wb.SheetNames[0]];
      const json = XLSX.utils.sheet_to_json(sheet, { header: 1 });

      if (json.length < 2) {
        info.innerText = "File has no data rows.";
        sheetRows = [];
        renderTable([], []);
        updateSendButton();
        return;
      }

      const headers = ["Name", "Email", "Attachment Name"];
      const idx = { name: 0, email: 1, attach: 2 };

      sheetRows = json
        .slice(1)
        .map(r => ({
          name: r[idx.name],
          email: r[idx.email],
          attachmentName: r[idx.attach]
        }))
        .filter(r => r.email);

      renderTable(headers, sheetRows);
      updateSendButton();
    } catch (err) {
      console.error("Parse error:", err);
      info.innerText = "Error reading file.";
    }
  };

  reader.readAsArrayBuffer(file);
}

function renderTable(headers, rows) {
  const container = document.getElementById("tableContainer");

  if (!rows.length) {
    container.innerHTML =
      '<p class="text-xs text-gray-500 mt-2">No valid rows detected.</p>';
    return;
  }

  let html = `
    <p class="text-xs text-gray-400 mb-2">
      Showing first 10 of ${rows.length} rows:
    </p>
    <div class="overflow-x-auto">
    <table class="preview-table">
      <thead><tr>
        ${headers.map(h => `<th>${h}</th>`).join("")}
      </tr></thead>
      <tbody>
  `;

  rows.slice(0, 10).forEach(r => {
    html += `
      <tr>
        <td>${r.name || ""}</td>
        <td>${r.email || ""}</td>
        <td>${r.attachmentName || ""}</td>
      </tr>
    `;
  });

  html += "</tbody></table></div>";
  container.innerHTML = html;
}

/* ================= ATTACHMENT UPLOAD ================= */
function setupAttachmentDragDrop() {
  const dz = document.getElementById("attachmentDropZone");
  const input = document.getElementById("attachmentInput");
  if (!dz || !input) return;

  dz.addEventListener("dragover", e => {
    e.preventDefault();
    dz.classList.add("dragover");
  });

  dz.addEventListener("dragleave", () => dz.classList.remove("dragover"));

  dz.addEventListener("drop", e => {
    e.preventDefault();
    dz.classList.remove("dragover");
    uploadAttachments(e.dataTransfer.files);
  });

  input.addEventListener("change", e => uploadAttachments(e.target.files));
}

async function uploadAttachments(filesList) {
  const status = document.getElementById("attachmentUploadStatus");
  const files = [...(filesList || [])];

  if (!files.length) {
    status.innerText = "No files selected.";
    return;
  }

  status.innerText = `Uploading ${files.length} files‚Ä¶`;

  const formData = new FormData();
  formData.append("mode", "uploadAttachments");
  files.forEach(f => formData.append("files", f, f.name));

  try {
    const res = await fetch(SCRIPT_WEBAPP_URL, {
      method: "POST",
      body: formData
    });

    const data = await res.json();

    if (Array.isArray(data)) {
      status.innerText = `Uploaded ${data.length} file(s) successfully.`;
    } else if (data.error) {
      status.innerText = "Upload failed: " + data.error;
    } else {
      status.innerText = "Upload completed.";
    }
  } catch (err) {
    console.error("Upload error:", err);
    status.innerText = "Upload failed.";
  }
}

/* ================= SEND EMAILS ================= */
function updateSendButton() {
  const btn = document.getElementById("sendBtn");
  if (!btn) return;

  const ok =
    accessToken &&
    sheetRows.length > 0 &&
    document.getElementById("subject").value.trim() &&
    document.getElementById("editor").value.trim() &&
    !sending;

  btn.disabled = !ok;

  if (ok) btn.classList.remove("opacity-60", "cursor-not-allowed");
  else btn.classList.add("opacity-60", "cursor-not-allowed");
}

async function startBulkSend() {
  sending = true;
  updateSendButton();

  failedRows = [];

  const subject = document.getElementById("subject").value.trim();
  const msg = document.getElementById("editor").value.trim();
  const total = sheetRows.length;

  const progressEl = document.getElementById("progress");
  const logEl = document.getElementById("log");
  const etaEl = document.getElementById("eta");
  const failedBtn = document.getElementById("failedBtn");

  failedBtn.classList.add("hidden");

  const start = Date.now();

  for (let i = 0; i < total; i++) {
    const r = sheetRows[i];
    const htmlBody = msg.replace(/{{Name}}/g, r.name || "User");

    progressEl.innerText = `Sending ${i + 1}/${total}`;
    logEl.innerText = `‚Üí ${r.email}`;

    const ok = await sendOne(r, subject, htmlBody);
    if (!ok) failedRows.push(r);

    const elapsed = (Date.now() - start) / 1000;
    const avg = elapsed / (i + 1);
    etaEl.innerText = `ETA: ${Math.round(avg * (total - i - 1))}s`;

    await new Promise(res => setTimeout(res, 300));
  }

  sending = false;
  updateSendButton();

  if (!failedRows.length) {
    progressEl.innerText = "All emails sent successfully! üéâ";
    document.getElementById("successSound").play().catch(() => {});
  } else {
    progressEl.innerText =
      `${total - failedRows.length}/${total} sent. ${failedRows.length} failed.`;
    failedBtn.classList.remove("hidden");
  }

  logEl.innerText = "Completed.";
  etaEl.innerText = "";
}

/* Send one email via Apps Script WebApp */
async function sendOne(r, subject, htmlBody) {
  try {
    const res = await fetch(SCRIPT_WEBAPP_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        mode: "sendEmailWithAttachmentName",
        to: r.email,
        subject,
        htmlBody,
        attachmentName: r.attachmentName,
        accessToken
      })
    });

    const data = await res.json();
    return !!data.success;
  } catch (err) {
    console.error("Error sending to", r.email, err);
    return false;
  }
}

/* ================= FAILED CSV ================= */
function downloadFailed() {
  if (!failedRows.length) return;

  let csv = "Name,Email,Attachment Name\n";
  failedRows.forEach(r => {
    csv += `"${r.name}","${r.email}","${r.attachmentName}"\n`;
  });

  const blob = new Blob([csv], { type: "text/csv" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "failed_rows.csv";
  link.click();
}

/* Re-check send button if user edits fields */
document.addEventListener("input", e => {
  if (e.target.id === "subject" || e.target.id === "editor") {
    updateSendButton();
  }
});
</script>

</body>
</html>
